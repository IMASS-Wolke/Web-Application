name: Projects v2 to Discord

on:
  workflow_dispatch: {}     # lets you test from the Actions tab
  projects_v2_item:
    types: [created, edited, moved, deleted]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Post Projects v2 event to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}   # NO /github at the end
          ACTION: ${{ github.event.action }}
          REPO: ${{ github.repository }}
          EVENT: ${{ toJson(github.event) }}
        run: |
          set -euo pipefail

          # Extract safe fields from the Projects v2 payload
          title=$(printf %s "$EVENT" | jq -r '.projects_v2_item?.title // .projects_v2_item?.content?.title // "Projects v2 item"')
          proj=$(printf %s "$EVENT"  | jq -r '.project?.title // .projects_v2_project?.title // "Project"')
          url=$(printf %s "$EVENT"   | jq -r '.projects_v2_item?.content?.html_url // empty')

          # Build message without fancy emoji or backticks (keeps YAML happy)
          msg="Project: ${proj} â€¢ ${ACTION}
Repo: ${REPO}
Title: ${title}"
          if [ -n "$url" ]; then
            msg="${msg}
${url}"
          fi

          # Send to Discord
          jq -n --arg c "$msg" '{content:$c}' > payload.json
          curl -sS -H 'Content-Type: application/json' -X POST \
               -d @payload.json "$DISCORD_WEBHOOK"
