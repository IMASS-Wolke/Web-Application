# IMASS Frontend (React)

## Quick start (frontend only)
- Requirements: Node.js 18.x, npm.
- Run: `cd frontend && npm install && npm run convert:fasst && npm start` (CRA dev server on `http://localhost:3000`). The convert script prebuilds `src/assets/converted-outputs/fasst.json` from the sample `fasst.out` file; do this before starting to avoid missing-data errors.
- Google OAuth: export `CLIENT_ID` before `npm start` (read in `src/index.js` via `GoogleOAuthProvider`). No `REACT_APP_` prefix is used yet.
- API base: hard-coded to `http://localhost:5103` in multiple components; change before building if backend port/host differs.

### First-time install commands
If `npm install` fails or package-lock is stale, install the dependencies explicitly:
```
cd frontend
npm install
npm install react-router-dom @microsoft/signalr react-dropzone reactflow jszip recharts @react-oauth/google@latest
npm install --save-dev ajv@^7
npm run convert:fasst
npm run start

The browser should open to http://localhost:3000/ and you should see the landing page.

To fix the error:
Cannot find module 'ajv/dist/compile/codegen'
We use:
npm install --save-dev ajv@^7

To build the JSON output from the fasst.out file:
npm run convert:fasst
Run this before starting the frontend so that the output file is ready to go on start.

Installing the packages is only necessary when cloning the repository for the first time, every time after, just open the terminal:

cd frontend

npm run start
```

## Project layout
- Entry: `src/index.js` wraps `App` with `BrowserRouter` and `GoogleOAuthProvider`.
- Routing shell: `src/App.js` renders `Navbar` and routes to Home, Login, Signup, Models (`ModelRunner`), FASST (legacy page), and Scene Builder.
- Styling: global tokens in `src/index.css`; page/component styles live next to components (e.g., `Navbar.css`, `ModelRunner.css`).
- Assets: `src/assets/icons/*` for UI icons; `src/assets/output-files/*` hold sample FASST outputs; `src/assets/converted-outputs/fasst.json` is generated by the converter script for sample charts.
- Utility scripts: `scripts/convertFasst.js` converts `assets/output-files/fasst.out` to JSON; run with `npm run convert:fasst`.

## Routing map
- `/home` (`Home/Home.js`): marketing copy + “Get Started” button -> `/models`.
- `/login` (`Login/Login.js`): email/password login; stores `accessToken` and `refreshToken` in `localStorage`, then routes to `/home`.
- `/signup` (`Signup/Signup.js`): creates account, then routes to `/login`.
- `/models` (`Models/ModelRunner/ModelRunner.js`): model toggle between SNTHERM and FASST runners.
- `/fasst` (`Models/FASST/FASST.js`): legacy/static FASST chart page (not linked from navbar).
- `/scene-builder` (`SceneBuilder/SceneBuilder.js`): interactive pipeline builder (drag nodes, drop inputs, run SNTHERM → FASST chain via backend).
- Default `/` redirects to `/home`; unknown routes show a 404 heading. `Navbar/Navbar.js` links Home/Models/Scene Builder and Login/Signup.

## Auth flow
- Login POST: `http://localhost:5103/api/Accounts/Login` with `{ username, password }` (username is the email field). On 200, saves `accessToken` + `refreshToken` to `localStorage`. No auto-refresh is implemented; consumers must attach tokens manually if needed (current API calls do not add Authorization headers).
- Signup POST: `http://localhost:5103/api/Accounts/signup` with `{ name, email, password }`; shows raw response text on failure. No password strength UI or validation beyond HTML required fields.
- Google login: commented out in `Login.js`; `CLIENT_ID` is the env var read by `index.js`.

## Model runner flows (core screens)

### SNTHERM (`Models/ModelRunner/SnthermRunner.js`)
- Uploads: two dropzones (`TEST.IN` -> `test_in`, `METSWE.IN` -> `metswe_in`). Optional text label appended as `Label`.
- Run: POST `http://localhost:5103/api/SnthermJob/run` with `FormData`; expects `{ runId, exitCode, outputs[] }`. Status text reflects exit code.
- Download: GET `http://localhost:5103/api/SnthermJob/runs/{runId}/zip` streams a ZIP; client builds a blob URL and downloads `{runId}_results.zip`.
- State: `status` string for user feedback, `result` object for run metadata, `finalLabel` echoes the entered label beside the run details.

### FASST (`Models/ModelRunner/FasstRunner.js`)
- Upload: single file chooser/drop zone; selected file stored in `selectedFile`.
- Run: POST `${backendBase}/run` (`backendBase = http://localhost:5103/api/FasstIntegration`). On success, marks `hasRun` and keeps `result` (expects optional `jobId`, `message`, `success` flags).
- Outputs list: GET `${backendBase}/outputs`; displays file names with download buttons that GET `${backendBase}/outputs/{file}/stream`.
- Charts: after a run or manual refresh, fetches text for target files (`fasst.out`, `ground.out`, `fluxes.out`, `veg_temp.out`, `snow_info.out`), parses tables, and renders Recharts line charts (first column becomes X-axis; numeric columns become Y series).
- Status: messages shown in `status`; errors for runs/downloads surface here.

### Health monitor
- `Models/ModelRunner/Health Checker/HealthPanel.js` connects via SignalR to `http://localhost:5103/hubs/health`, listens for `healthUpdate`, and renders `payload.status` plus each `entry.name/status/durationMs`. Connection state is displayed inline.

## Scene builder chain (SNTHERM → FASST)
- Graph: add Input/SNTHERM/FASST/Output nodes; connect with edges. Input nodes auto-set mode based on their outgoing edge target (SNTHERM vs FASST).
- Inputs: dropzones on Input nodes (SNTHERM expects `TEST.IN` + `METSWE.IN`; FASST-only flow can accept a single FASST input file). Uses `react-dropzone`.
- Execution: topological order across the graph. When SNTHERM is present, `runSntherm` POSTs `FormData` (`model_name=SNTHERM`, `scenario_name=Scene`, `inputFile1=testIn`, `inputFile2=metSweIn`) to `http://localhost:5103/api/ScenarioBuilder/run`; then downloads `http://localhost:5103/api/SnthermJob/runs/{runId}/zip`, opens it with JSZip, and extracts `brock.out` as a `File`.
- FASST stage: `runFasst` POSTs `FormData` (`model_name=FASST`, `scenario_name=Scene`, `inputFile1=<brock.out or input file>`) to the same ScenarioBuilder `/run` endpoint. Both stages record JSON responses into the output panel.
- UI: toolbar buttons add nodes; “Run Scene” executes the chain; output panel shows SNTHERM and FASST JSON responses.

## Legacy/secondary UI
- `Models/FASST/FASST.js`: static sample chart (via `Outputs/Fasst-outputs.jsx`) and a commented form stub that would POST to `/api/Job/${jobId}/models/${modelId}/Fasst`.
- `Upload/Upload.js`: generic dropzone demo not wired to APIs; tracks chosen “model” locally.
- `Outputs/Fasst-outputs.jsx`: renders `assets/converted-outputs/fasst.json` with Recharts for demo purposes.

## Configuration touchpoints (update these when changing environments)
- API host/port: hard-coded in `Login/Login.js`, `Signup/Signup.js`, `Models/ModelRunner/SnthermRunner.js`, `Models/ModelRunner/FasstRunner.js`, `Models/ModelRunner/Health Checker/HealthPanel.js`, and `SceneBuilder/SceneBuilder.js` (ScenarioBuilder + SnthermJob endpoints). Consider centralizing into an env-driven config (e.g., `REACT_APP_API_BASE`).
- OAuth client ID: `GoogleOAuthProvider` reads `process.env.CLIENT_ID`; align to CRA’s `REACT_APP_` convention to expose in the browser build.
- CORS: frontend assumes backend allows `http://localhost:3000`.

## Data & assets
- Sample FASST outputs live under `src/assets/output-files/`; helpful for parsing/charting tests. `scripts/convertFasst.js` converts `fasst.out` into `converted-outputs/fasst.json` used by the demo chart.
- Icons (cloud, home, download, arrows) under `src/assets/icons/` are imported by navbar/buttons.

## Build/test scripts (package.json)
- `npm start` – CRA dev server.
- `npm run build` – production bundle.
- `npm test` – CRA test runner (no app-specific tests added yet).
- `npm run convert:fasst` – regenerate `converted-outputs/fasst.json` from `output-files/fasst.out`.

## Troubleshooting
- `Cannot find module 'ajv/dist/compile/codegen'`: install AJV v7 as a dev dependency (`npm install --save-dev ajv@^7`) then rerun `npm start`.


